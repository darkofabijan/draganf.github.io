<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

  <title>Thunder - Basic routing DSL</title>
  <link rel="stylesheet" href="/stylesheets/default.css" type="text/css" media="screen" charset="utf-8" />
  <link rel="stylesheet" href="/stylesheets/syntax.css" type="text/css" media="screen" charset="utf-8" />
  <link rel="shortcut icon" type="image/png" href="favicon.png" />
  <link rel="alternate" type="application/rss+xml" title="thunder-ex.org" href="http://thunder-ex.org/feed.xml">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-47281287-1', 'thunder-ex.github.io');
  ga('send', 'pageview');
  </script>

</head>


<body>
  <div class = "site">
    <div span="title"><a href="/"><img src="/images/logo-icon.png" height="17"> Thunder</a> - Elixir Web Framework</div>

    <div id = 'post'><h1>Basic routing DSL</h1>

<p><small>On Monday, January 20, 2014 by Darko Fabijan</small></p>

<p>In previous post we saw how we can parse request paths and route patterns. Just as a remainder I will quickly sum up what we did.</p>

<p>We had a path that we received in HTTP request:</p>

<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="o">/</span><span class="n">albums</span><span class="o">/</span><span class="mi">123</span><span class="o">/</span><span class="n">photos</span><span class="o">/</span><span class="mi">5</span></code></pre></div>


<p>After parsing we turned it into</p>

<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="p">[</span><span class="ss">segment</span><span class="p">:</span> <span class="s2">&quot;albums&quot;</span><span class="p">,</span> <span class="ss">segment</span><span class="p">:</span> <span class="s2">&quot;123&quot;</span><span class="p">,</span> <span class="ss">segment</span><span class="p">:</span> <span class="s2">&quot;photos&quot;</span><span class="p">,</span> <span class="ss">segment</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">]</span></code></pre></div>


<p>We also have route pattern, which is not very different from request path:</p>

<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="o">/</span><span class="n">albums</span><span class="o">/</span><span class="ss">:album_id</span><span class="o">/</span><span class="n">photos</span><span class="o">/</span><span class="ss">:id</span></code></pre></div>


<p>After parsing we got:</p>

<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="p">[</span><span class="ss">segment</span><span class="p">:</span> <span class="s2">&quot;albums&quot;</span><span class="p">,</span> <span class="ss">binding</span><span class="p">:</span> <span class="s2">&quot;album_id&quot;</span><span class="p">,</span> <span class="ss">segment</span><span class="p">:</span> <span class="s2">&quot;photos&quot;</span><span class="p">,</span> <span class="ss">binding</span><span class="p">:</span> <span class="s2">&quot;id&quot;</span><span class="p">]</span></code></pre></div>


<p>It's almost the same structure that we got after parsing path but it has <em>binding</em> elements which enabled us to match requested path to defined routes. Also keep in mind that we haven't included HTTP method in matching so far.</p>

<h2>Towards DSL</h2>

<p>In this section we will see what routing DSL should produce for us so we can use it in the system that we have created so far. Pull request relevant to this post is <a href="https://github.com/thunder-ex/thunder/pull/2">#2</a></p>

<p>Obviously we need path pattern and HTTP method. Along with those two need controller and action that should be called upon a match. So first we will define data structure that would be nice for that use.</p>

<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="p">[[</span><span class="ss">method</span><span class="p">:</span> <span class="s2">&quot;GET&quot;</span><span class="p">,</span>  <span class="ss">path</span><span class="p">:</span> <span class="s2">&quot;/photos&quot;</span><span class="p">,</span> <span class="ss">controller</span><span class="p">:</span> <span class="ss">:photos</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:index</span><span class="p">],</span>
 <span class="p">[</span><span class="ss">method</span><span class="p">:</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="ss">path</span><span class="p">:</span> <span class="s2">&quot;/photos&quot;</span><span class="p">,</span> <span class="ss">controller</span><span class="p">:</span> <span class="ss">:photos</span><span class="p">,</span> <span class="ss">action</span><span class="p">:</span> <span class="ss">:create</span><span class="p">]]</span></code></pre></div>


<p>This is the part where it started to get a bit slippery because I haven't really figured out would be easy way to aggregate data. Immutability is a concept that can hurt a bit at first. This is where three excellent posts by Saša Jurić really helped so I am referencing them here.</p>

<ol>
<li><a href="http://www.theerlangelist.com/2013/05/working-with-immutable-data.html">Working with immutable data</a></li>
<li><a href="http://www.theerlangelist.com/2013/06/immutable-programming-oo-style.html">Immutable programming, OO style</a></li>
<li><a href="http://www.theerlangelist.com/2013/07/immutable-programming-fp-style.html">Immutable programming, FP style</a></li>
</ol>


<p>Along with those post <a href="http://elixir-lang.org/blog/2012/04/21/hello-macros/">Building a Web Framework. Part I</a> by Alexei Sholik came very handy.</p>

<p>In the end I ended up with following "DSL" which is built with very only one macro and is not real DSL but it can serve as a prof of concept at this stage.</p>

<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="kd">defmodule</span> <span class="nc">ResourcesRoutesTest</span> <span class="k">do</span>
   <span class="kn">use</span> <span class="nc">Thunder.Router.Drawer</span>

   <span class="n">draw</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:albums</span><span class="p">)</span>
     <span class="o">|&gt;</span> <span class="n">resources</span><span class="p">(</span><span class="ss">:photos</span><span class="p">)</span>
<span class="k">end</span></code></pre></div>


<p>It gives us <code>ResourcesRoutesTest.all</code> function which returns structure defined in the begging of this section. Once we return to request handler module it will be used instead of current stubbed routes. Very rough prototype like this one will be enough at the moment. This part will need a lot of love in future because I would not like to settle with anything less pleasant to use than Rails router.</p>

<p>If you have have experience with macros this could be an interesting exercise. Ideal routing DSL should look something like:</p>

<div class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="kd">defmodule</span> <span class="nc">ResourcesRoutesTest</span> <span class="k">do</span>
   <span class="kn">use</span> <span class="nc">Thunder.Router.Drawer</span>

   <span class="n">draw</span> <span class="k">do</span>
     <span class="n">resources</span><span class="p">(</span><span class="ss">:albums</span><span class="p">,</span> <span class="p">[</span><span class="ss">only</span><span class="p">:</span> <span class="p">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:show</span><span class="p">]])</span> <span class="k">do</span>
       <span class="n">resources</span><span class="p">(</span><span class="ss">:photos</span><span class="p">,</span> <span class="p">[</span><span class="ss">controller</span><span class="p">:</span> <span class="ss">:images</span><span class="p">])</span>
     <span class="k">end</span>

     <span class="n">resources</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span>

     <span class="n">namespace</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span> <span class="k">do</span>
       <span class="n">resources</span><span class="p">(</span><span class="ss">:users</span><span class="p">)</span>
     <span class="k">end</span>
   <span class="k">end</span>
<span class="k">end</span></code></pre></div>


<p>Next I will work on Thunder project generator, try to connect what we have so far together and based on that continue.</p>
</div>

    <div id="disqus_thread"></div>
<script type="text/javascript">
     /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
     var disqus_shortname = 'thunder-ex'; // required: replace example with your forum shortname

     /* * * DON'T EDIT BELOW THIS LINE * * */
     (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
 </script>
 <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
 <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



    <div class='footer'>
  <div class="contact">
    <p>
      Thunder is released under the MIT license.<br/>
      <small>Site is built using <a href="http://jekyllrb.com" class="silent">Jekyll</a> and theme created by <a href="http://michaelrbernste.in/" class="silent">Michael Robert Bernstein</a>. It's <a href="https://github.com/thunder-ex/thunder-ex.github.io" class="silent">open-source</a>.</small>
    </p>
  </div>
</div>


  </div>
</body>

</html>
